<!doctype html>
<html lang="en">
  
  <head>
    <link rel="stylesheet" type="text/css" href="/semantic-ui/semantic.min.css">
    <script src="/jquery/jquery.min.js"></script>
    <script src="/jquery/sha1.js"></script>
    <script src="/semantic-ui/semantic.min.js"></script>
    <meta charset="UTF-8">
    <title>User {{ name }}</title>
    <style type="text/css">body { background-color: #FFFFFF; } body > .grid { top: 50%; } .trackcolumn { max-width: 800px; background-color: #FFFFFF; }</style></head>
  
  <body>
    <div class="ui middle aligned center aligned column grid">
      <div class="row"></div>
      <div class="row"></div>
      <div class="row"></div>
      <div class="row">
        <div class="ui three wide column">
          <div class="ui card">
            <div class="image">
              <img src="/image/avatar/avatar.png"></div>
            <div class="content">
              <a class="header" id="username">Kristy</a>
              <div class="meta">
                <span class="description" id="nickname">Joined in 2017</span></div>
              <div class="description" id="city">Living in New York.</div>
              <div class="meta">&nbsp</div>
              <button class="ui violet button" id="follow">Follow</button></div>
            <div class="extra content">
              <a>
                <i class="user icon"></i>
                <i id="followers">22 Followers</i></a>
            </div>
          </div>
        </div>
        <div class="fifteen wide column trackcolumn">
          <h3 class="ui violet header">
            <i class="music icon"></i>
            <div class="content">Playlists</div></h3>
          <table class="ui selectable celled compact table raised segment center aligned" id="playlists">
            <thead>
              <tr>
                <th>Playlist Name</th>
                <th>Created on</th>
                <th>Play Times</th>
                <th>Detail</th></tr>
            </thead>
            <tbody></table>
          <div class="ui negative message hidden"></div>
        </div>
      </div>
    </div>
  </body>
  <script>$(document).ready(function() {
      $.ajax({
        type: 'get',
        url: '/api/getplaylists/',
        data: {
          username: '{{ name }}'
        },
        success: function(data) {
          if (data.status == "error") {
            $('.ui .message').text(data.error);
            $('.ui .message').removeClass("hidden");
            $('.ui .detailbutton').removeClass("loading");
            $('.ui .detailbutton').removeClass("disabled");
          }
          if (data.status == "success") {
            jQuery.each(data.playlists,
            function(i, row) {
              // console.log(data);
              $("#playlists").append("<tr><td>" + row.title + "</td><td>" + row.time + "</td><td>" + row.count + "</td><td><button class='ui violet button playlistbutton' value=" + row.plid + ">Detail</button></td></tr>");
            });
          }
          $('.playlistbutton').click(function() {
            window.location.href = "/playlist/" + $(this).val();
          });
        }
      });
      $.ajax({
        type: 'get',
        url: '/api/getuser/',
        data: {
          username: '{{ name }}'
        },
        success: function(data) {
          if (data.status == "error") {}
          if (data.status == "success") {
            $("#username").text(data.username);
            $("#nickname").text(data.nickname);
            $("#city").val("Living in" + data.city + ".");
            $("#followers").text(data.followers + " followers");
          }
        }
      });
      $.ajax({
        type: 'get',
        url: '/api/getfollowstatus/',
        data: {
          username: '{{ name }}'
        },
        success: function(data) {
          if (data.status == "error") {}
          if (data.status == "success") {
            if (data.followstatus == 0) {
              $('#follow').text('Follow');
              $('#follow').addClass('violet');
              $('#follow').removeClass('loading');
            }
            if (data.followstatus == 1) {
              $('#follow').text('Following');
              $('#follow').removeClass('violet');
              $('#follow').removeClass('loading');
            }
          }
        }
      });
      $("#follow").click(function(event) {
        console.log('haha');
        //$("#follow").addClass("loading");
        console.log($("#follow").text());
        if ($("#follow").text() == "Following") {
          $.ajax({
            type: 'post',
            url: '/api/unfollow/',
            data: {
              username: '{{ name }}'
            },
            success: function(data) {
              if (data.status == "error") {}
              if (data.status == "success") {

                $('#follow').text('Follow');
                $('#follow').addClass('violet');
                $.ajax({
                  type: 'get',
                  url: '/api/getuser/',
                  data: {
                    username: '{{ name }}'
                  },
                  success: function(data) {
                    if (data.status == "error") {}
                    if (data.status == "success") {
                      $("#username").text(data.username);
                      $("#nickname").text(data.nickname);
                      $("#city").val("Living in" + data.city + ".");
                      $("#followers").text(data.followers + " followers");
                    }
                  }
                });
              }
            }
          });
        } else {
          $.ajax({
            type: 'post',
            url: '/api/follow/',
            data: {
              username: '{{ name }}'
            },
            success: function(data) {
              if (data.status == "error") {}
              if (data.status == "success") {

                $('#follow').text('Following');
                $('#follow').removeClass('violet');
                $.ajax({
                  type: 'get',
                  url: '/api/getuser/',
                  data: {
                    username: '{{ name }}'
                  },
                  success: function(data) {
                    if (data.status == "error") {}
                    if (data.status == "success") {
                      $("#username").text(data.username);
                      $("#nickname").text(data.nickname);
                      $("#city").val("Living in" + data.city + ".");
                      $("#followers").text(data.followers + " followers");
                    }
                  }
                });
              }
            }
          });
        }

      });
    });</script>

</html>